<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/dinamicas/promocion-ruleta-dinamica/ruleta_view/ruleta_view.css"> -->
    <title>Aladdin: View Ruleta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: 'Poppins Ligth', sans-serif !important;
            box-sizing: border-box;
        }

        html,
        body {
            overflow-x: hidden;
            scroll-behavior: auto;
            margin: 0;
            padding: 0;
            scrollbar-color: #7e0f0f #460500;
        }

        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 6px solid #ccc;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .content_view_ruleta {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            background-color: #002a46;
        }

        .content_logo_ {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            gap: 10px;
            z-index: 10;
            top: 0;
            left: 0;
        }

        .content_logo_ img {
            width: 80px;
            border-radius: 0 20px 20px 20px;
        }

        .content_opciones_ruleta {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .content_opciones_ruleta img {
            width: 30px;
            transition: all 0.4s ease;
        }

        .content_opciones_ruleta img:hover {
            opacity: 0.7;
            cursor: pointer;
        }

        .content_board_ruleta {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            padding: 10px 0;
        }

        .content_actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            width: auto;
            margin-bottom: 10px;
        }

        .content_actions button {
            width: 100%;
            padding: 2px;
        }

        .content_actions select {
            display: none;
        }

        .roulette-container {
            position: relative;
        }

        #selector {
            position: absolute;
            top: -20px;
            left: 50%;
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 50px solid transparent;
            border-right: 50px solid transparent;
            border-top: 50px solid #f2f2f2;
            z-index: 3;
            transform: translateX(-50%);
        }

        #ruleta {
            background: #fff;
            width: 400px;
            height: 400px;
            position: relative;
            font-size: 14px;
            overflow: hidden;
            border-radius: 100%;
            transform: rotate(0deg);
            z-index: 1;
            transition: none;
        }

        #ruleta .roulette-section {
            position: absolute;
            overflow: hidden;
            top: 0;
            right: 0;
            width: 50%;
            height: 50%;
            transform-origin: 0% 100%;
        }

        #ruleta .roulette-section .roulette-section-container {
            position: absolute;
            left: -100%;
            width: 200%;
            height: 200%;
            text-align: center;
            padding-top: 60px;
            transform: skewY(60deg) rotate(15deg);
        }

        #ruleta .roulette-section .roulette-section-container p {
            margin-top: 30px;
            transform: rotate(90deg);
            color: white;
        }

        /* Colores de secciones */
        #ruleta .roulette-section:nth-child(1) .roulette-section-container {
            background: #df0978;
        }

        #ruleta .roulette-section:nth-child(2) .roulette-section-container {
            background: #8d078d;
        }

        #ruleta .roulette-section:nth-child(3) .roulette-section-container {
            background: #3a63ba;
        }

        #ruleta .roulette-section:nth-child(4) .roulette-section-container {
            background: #4fa1de;
        }

        #ruleta .roulette-section:nth-child(5) .roulette-section-container {
            background: #23bb23;
        }

        #ruleta .roulette-section:nth-child(6) .roulette-section-container {
            background: #46b545;
        }

        #ruleta .roulette-section:nth-child(7) .roulette-section-container {
            background: #88c740;
        }

        #ruleta .roulette-section:nth-child(8) .roulette-section-container {
            background: #f2f215;
        }

        #ruleta .roulette-section:nth-child(9) .roulette-section-container {
            background: #f1b041;
        }

        #ruleta .roulette-section:nth-child(10) .roulette-section-container {
            background: #e35825;
        }

        #ruleta .roulette-section:nth-child(11) .roulette-section-container {
            background: #e01423;
        }

        #ruleta .roulette-section:nth-child(12) .roulette-section-container {
            background: #ffae00;
        }

        #ruleta .roulette-section:nth-child(13) .roulette-section-container {
            background: #df0978;
        }

        #ruleta .roulette-section:nth-child(14) .roulette-section-container {
            background: #8d078d;
        }

        #ruleta .roulette-section:nth-child(15) .roulette-section-container {
            background: #3a63ba;
        }

        #ruleta .roulette-section:nth-child(16) .roulette-section-container {
            background: #4fa1de;
        }

        #ruleta .roulette-section:nth-child(17) .roulette-section-container {
            background: #23bb23;
        }

        #ruleta .roulette-section:nth-child(18) .roulette-section-container {
            background: #46b545;
        }

        #ruleta .roulette-section:nth-child(19) .roulette-section-container {
            background: #88c740;
        }

        #ruleta .roulette-section:nth-child(20) .roulette-section-container {
            background: #f2f215;
        }

        #ruleta .roulette-section:nth-child(21) .roulette-section-container {
            background: #f1b041;
        }

        #ruleta .roulette-section:nth-child(22) .roulette-section-container {
            background: #e35825;
        }

        #ruleta .roulette-section:nth-child(23) .roulette-section-container {
            background: #e01423;
        }

        #ruleta .roulette-section:nth-child(24) .roulette-section-container {
            background: #ffae00;
        }

        #ruleta .roulette-section:nth-child(25) .roulette-section-container {
            background: #df0978;
        }

        #ruleta .roulette-section:nth-child(26) .roulette-section-container {
            background: #8d078d;
        }


        /* Rotaciones de secciones */
        #ruleta .roulette-section:nth-child(1) {
            transform: rotate(0deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(2) {
            transform: rotate(30deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(3) {
            transform: rotate(60deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(4) {
            transform: rotate(90deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(5) {
            transform: rotate(120deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(6) {
            transform: rotate(150deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(7) {
            transform: rotate(180deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(8) {
            transform: rotate(210deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(9) {
            transform: rotate(240deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(10) {
            transform: rotate(270deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(11) {
            transform: rotate(300deg) skewY(-60deg);
        }

        #ruleta .roulette-section:nth-child(12) {
            transform: rotate(330deg) skewY(-60deg);
        }

        .button-container {
            position: absolute;
            top: -90px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            z-index: 5;
        }

        .button-container button {
            border: none;
            outline: none;
            padding: 15px 60px;
            background: linear-gradient(145deg, #007bff, #0056d8);
            color: #fff;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .button-container button:hover {
            background: linear-gradient(145deg, #005ce6, #0042b0);
            transform: scale(1.05);
        }

        .button-container button:active {
            transform: scale(0.98);
            background: linear-gradient(145deg, #0042b0, #003190);
        }

        #ruleta-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            background: #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.25);
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: red;
            opacity: 0.8;
            z-index: 10;
            pointer-events: none;
            animation: fall linear forwards;
        }

        @keyframes fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(300px) rotate(720deg);
                opacity: 0;
            }
        }

        .config_view_ruleta {
            display: none;
        }

        .content_btn_reset {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1;
        }

        .item_disable {
            pointer-events: none;
            opacity: 0.7;
        }

        @media(max-width:1366px) {
            .config_view_ruleta {
                position: relative;
                top: 40px;
            }
        }
    </style>
</head>

<body>
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>
    <div class="content_view_ruleta">
        <div class="content_logo_">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRrjvqndqpZmhVnbbbHqGRUIhtjfLUa1X8shQ&s"
                alt="Integrador">
            <div class="content_actions">
                <button id="btn_carga_ruleta" class="btn btn-primary">Cargar ruletas</button>
                <select class="form-control" name="ruletas" id="ruletas">
                    <option value="">Seleccionar...</option>
                </select>
            </div>
        </div>
        <div class="content_btn_reset">
            <button id="btn_reset" class="btn btn-danger">Reiniciar</button>
            <button style="display: none;" id="btn_send" class="btn btn-primary">Enviar</button>
        </div>
        <div class="content_board_ruleta">
            <section id="roulette-container" class="roulette-container config_view_ruleta">
                <div class="button-container">
                    <button type="button" id="btn-girar">Â¡Girar!</button>
                </div>
                <div id="selector"></div>
                <div id="ruleta" class="ruleta">
                    <div id="resultado"></div>
                </div>
            </section>


        </div>
    </div>
    <!-- <div id="modal_opciones_" class="modal_opciones_rule">
        <div class="content_modal_rule">
            <div id="close_modal_rule" class="close_modal_rule">&times;</div>
            <div class="info_modal_rule">
                <h2>Eliminar ruleta</h2>
                <br />
                <select class="form-control" name="ruletas" id="ruletas_eliminar">
                    <option value="">Seleccionar...</option>
                </select>
                <br />
                <div>
                    <button id="btn_eliminar" class="btn btn-danger">Eliminar</button>
                    <button id="btn_cargar_rule_eliminar" class="btn btn-primary">Cargar Ruletas</button>
                </div>
            </div>
        </div>
    </div> -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- <script src="/dinamicas/promocion-ruleta-dinamica/ruleta_view/ruleta_view.js"></script> -->
    <script>
        window.addEventListener("load", () => {
            document.getElementById("loader").style.display = "none";
        });

        window.addEventListener("DOMContentLoaded", () => {
            const btn_carga_ruleta = document.getElementById("btn_carga_ruleta");
            const btn_reset = document.getElementById("btn_reset");
            const btn_send = document.getElementById("btn_send");
            const btn_opciones = document.getElementById("btn_opciones");
            const close_modal_rule = document.getElementById("close_modal_rule");
            const btn_eliminar = document.getElementById("btn_eliminar");
            const btn_cargar_rule_eliminar = document.getElementById("btn_cargar_rule_eliminar");

            const ruletas = document.getElementById("ruletas");
            const ruletas_eliminar = document.getElementById("ruletas_eliminar");
            const url_ruleta =
                "https://script.google.com/macros/s/AKfycbxDn2u1somk0VSw2_A4y92UCmoI1ypu5hvHK14QEq3ge_l98t6biNy2EstWusj1K4Tq/exec";

            let ultimaConfig = null;
            let valorSendOdo = "";

            function pintarRuleta(config) {
                ultimaConfig = config;

                const ruleta = document.getElementById("ruleta");
                ruleta.innerHTML = "";

                ruleta.style.transition = "none";
                ruleta.style.transform = "rotate(0deg)";

                const labels = [];
                console.log(config);

                for (let i = 1; i <= config.cant_campos; i++) {
                    const valor = String(config[`campo_${i}`] ?? "").trim().substring(1);

                    if (valor.includes("%")) {
                        console.log("entro a %");
                    }

                    if (valor !== "") {
                        labels.push(valor);
                    }
                }

                labels.forEach((val, i) => console.log(`Campo ${i + 1}: ${val}`));

                const cantidad = labels.length;
                if (cantidad === 0) return;

                const angle = 360 / cantidad;
                const skew = 90 - angle;

                labels.forEach((texto, index) => {
                    const section = document.createElement("div");
                    section.className = "roulette-section";
                    section.style.transform = `rotate(${index * angle
                        }deg) skewY(-${skew}deg)`;

                    const container = document.createElement("div");
                    container.className = "roulette-section-container";
                    container.style.transform = `skewY(${skew}deg) rotate(${angle / 2}deg)`;

                    const p = document.createElement("p");
                    p.textContent = texto;

                    if (cantidad <= 8) {
                        p.style.fontSize = "14px";
                    } else if (cantidad <= 16) {
                        p.style.fontSize = "12px";
                    } else {
                        p.style.fontSize = "10px";
                    }
                    section.appendChild(p);
                    container.appendChild(p);
                    section.appendChild(container);
                    ruleta.appendChild(section);
                });

                const center = document.createElement("div");
                center.id = "roulette-center";
                ruleta.appendChild(center);

                // el giro
                ruleta.dataset.totalSegmentos = cantidad;
                ruleta.dataset.direccion = config.direccion || 1;
                ruleta.dataset.girosMinimo = config.giros_minimo || 3;
                ruleta.dataset.girosMaximo =
                    config.giros_maximo || config.giros_minimo || 3;
            }

            const btnGirar = document.getElementById("btn-girar");
            const resultado = document.getElementById("resultado");

            let anguloActual = 0;

            let currentRotation = 0;

            btnGirar.addEventListener("click", () => {
                const ruleta = document.getElementById("ruleta");
                const sections = Array.from(
                    ruleta.querySelectorAll(".roulette-section-container p")
                );
                if (sections.length === 0) return;

                const direccion = Number(ruleta.dataset.direccion) || 1;
                const girosMinimo = Number(ruleta.dataset.girosMinimo) || 3;
                const girosMaximo = Number(ruleta.dataset.girosMaximo) || girosMinimo;

                btnGirar.style.display = "none";

                const total = sections.length;
                const anguloPorSeccion = 360 / total;
                const indiceGanador = Math.floor(Math.random() * total);
                const anguloCentro =
                    indiceGanador * anguloPorSeccion + anguloPorSeccion / 2;

                const spins =
                    Math.floor(Math.random() * (girosMaximo - girosMinimo + 1)) + girosMinimo;

                const extraRotation = 4000 * direccion * (spins / 2);

                const extra = spins * 360 + anguloCentro;

                currentRotation += direccion * extra + 1;

                ruleta.style.transition = `transform ${spins}s ease-out`;
                ruleta.style.transform = `rotate(${currentRotation}deg)`;

                const handler = () => {
                    ruleta.removeEventListener("transitionend", handler);
                    btnGirar.style.display = "flex";

                    const normalizedDeg =
                        (360 - (((currentRotation % 360) + 360) % 360) + 360) % 360;

                    const anguloPorSeccion = 360 / sections.length;
                    const index =
                        Math.floor(normalizedDeg / anguloPorSeccion) % sections.length;

                    const resultText = sections[index].textContent;

                    if (resultado) {
                        resultado.textContent = `Resultado: ${resultText}`;
                    }

                    if (resultText.toUpperCase().includes("GANA")) {
                        let text = resultText.split(" ");
                        let texto = text[1];
                        Swal.fire({
                            icon: "success",
                            title: `Felicidades `,
                            text: `Ganaste un ${texto} en casinos aladdin`,
                            allowOutsideClick: false
                        });
                    }

                    window.localStorage.setItem("valorOdo", resultText);

                    // ruleta.style.transition = "transform 0.4s ease-out";
                    // ruleta.style.transform = `rotate(${currentRotation + direccion * 5}deg)`;
                    // setTimeout(() => {
                    //     ruleta.style.transform = `rotate(${currentRotation}deg)`;
                    // }, 400);
                };

                ruleta.addEventListener("transitionend", handler);
            });

            let allRuletas = []; // arreglo global

            function getAllRuleta() {
                ruletas.innerHTML = `<option value="">Cargando...</option>`;
                btn_carga_ruleta.textContent = "Cargando...";
                btn_carga_ruleta.classList.add("item_disable");

                fetch(url_ruleta)
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.length === 0) {
                            ruletas.style.display = "flex";
                            btn_carga_ruleta.textContent = "Cargar ruletas";
                            ruletas.innerHTML = `<option value="">No hay ruletas</option>`;
                            ruletas_eliminar.innerHTML = `<option value="">No hay ruletas</option>`;
                            return;
                        }
                        allRuletas = Array.isArray(data) ? data : [];
                        const rondas = [...new Set(allRuletas.map((r) => r.nombre_ruleta))];
                        ruletas.style.display = "flex";
                        btn_carga_ruleta.classList.remove("item_disable");
                        btn_carga_ruleta.textContent = "Cargar ruletas";
                        ruletas.innerHTML = `<option value="">Seleccione la Ruleta</option>`;
                        rondas.forEach((lista) => {
                            if (!lista) return;
                            const option = document.createElement("option");
                            option.value = lista;
                            option.textContent = lista;
                            ruletas.appendChild(option);
                        });
                    })
                    .catch((err) => console.error(err));
            }

            ruletas.addEventListener("change", (e) => {
                const nombre = e.target.value;
                ruletas.style.display = "none";
                const config = allRuletas.find((r) => r.nombre_ruleta === nombre);
                if (config) {
                    pintarRuleta(config);
                    document.getElementById("roulette-container").style.display = "flex";
                } else {
                    document.getElementById("roulette-container").style.display = "none";
                }
            });

            btn_carga_ruleta.addEventListener("click", () => {
                getAllRuleta();
            });

            btn_reset.addEventListener("click", () => {
                Swal.fire({
                    title: "Estas seguro?",
                    text: "Se reiniciara todo en pantalla",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Si Quiero!",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed) {
                        window.localStorage.removeItem("valorOdo");
                        Swal.fire({
                            title: "Reinicio exitoso",
                            icon: "success",
                            allowOutsideClick: false,
                        }).then((res) => {
                            if (res.isConfirmed) {
                                window.location.reload();
                            }
                        });
                    }
                });
            });

            btn_send.addEventListener("click", () => {
                document.getElementById("loader").style.display = "flex";
                setTimeout(() => {
                    document.getElementById("loader").style.display = "none";
                    Swal.fire({
                        title: "Envio exitoso",
                        icon: "success",
                        text: "El se realizo de manera exitosa."
                    }).then((res) => {
                        if (res.isConfirmed) {
                            // window.close();
                        }
                    })
                }, 3000);
            });
        });
    </script>
 <script src="/dinamicas/extension.js"></script>
</body>

</html>