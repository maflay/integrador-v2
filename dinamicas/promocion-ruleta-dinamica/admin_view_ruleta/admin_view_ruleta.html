<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="/dinamicas/promocion-ruleta-dinamica/admin_view_ruleta/style_rule.css">
    <link rel="stylesheet" href="/dinamicas/promocion-ruleta-dinamica/admin_view_ruleta/admin_view_ruleta.css">
    <title>Aladdin: Admin View Ruleta</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            font-family: 'Poppins Ligth', sans-serif !important;
            box-sizing: border-box;
        }

        html,
        body {
            overflow-x: hidden;
            scroll-behavior: auto;
            margin: 0;
            padding: 0;
            scrollbar-color: #7e0f0f #460500;
            height: 100%;
        }


        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 6px solid #ccc;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .content_main_admin_ruleta {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            background-color: black;
        }

        .content_info_admin {
            display: none;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            padding: 10px;
            gap: 10px;
            background-color: rgba(0, 41, 94, 0.753);
        }

        .content_menu_lat {
            padding: 20px;
            width: 30%;
            height: 100%;
            overflow-y: auto;
            position: relative;
            border-radius: 20px 0 0 20px;
            color: white;
            background-color: #003e5ac2;
        }

        .content_info_menu_lat {
            display: flex;
            flex-direction: column;
            align-items: start;
            justify-content: start;
            width: 100%;
            gap: 10px;
        }

        .content_main_ruleta {
            padding: 20px;
            color: white;
            width: 70%;
            overflow-y: auto;
            height: 100%;
            border-radius: 0 20px 20px 0;
            background-color: #005383c2;
        }

        .content_infor_main_ruleta {
            display: flex;
            justify-content: start;
            align-items: start;
            flex-direction: column;
            position: relative;
            width: 100%;
            height: 100%;
        }

        .content_infor_main_ruleta h2 {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .content_input_label {
            display: flex;
            justify-content: start;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
            width: 100%;
            padding: 5px 0;
        }

        .menu_confi {
            flex-direction: column;
            line-height: 1rem;
        }

        .content_input_label p {
            opacity: 0.7;
            display: flex;
            justify-content: start;
            align-items: start;
            width: 100%;
        }

        .item_centrado {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .content_inputs {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-height: 200px;
            overflow-y: auto;
            padding: 5px 0;
            gap: 5px;
        }

        .olvidar_usuario {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .olvidar_usuario:hover {
            background-color: rgb(134, 15, 15);
        }

        .btn_crear_ruleta {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: absolute;
            right: 0;
        }

        .btn_crear_ruleta:hover {
            background-color: #004997;
        }

        .btn_clean_board {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: absolute;
        }

        .btn_clean_board:hover {
            background-color: rgb(148, 0, 0);
        }

        .btn_enviar_ruleta {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.4s ease;
            position: absolute;
            bottom: 0;
            right: 0;
        }

        .btn_enviar_ruleta:hover {
            background-color: #004997;
        }

        .campo_incorrecto {
            border: red 2px solid;
        }

        .content_info_user {
            position: absolute;
            bottom: 0;
            font-size: 12px;
            opacity: 0.7;
        }

        .item_disable {
            pointer-events: none;
            opacity: 0.7;
        }

        .content_img_head {
            width: 250px;
        }

        .swal2-input {
            width: 250px;
        }

        .modal_opciones_rule {
            display: none;
            justify-content: center;
            align-items: center;
            position: fixed;
            z-index: 1000;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .content_modal_rule {
            width: 950px;
            height: 100%;
            max-height: 500px;
            background-color: white;
            border-radius: 20px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            position: relative;
        }

        .close_modal_rule {
            position: absolute;
            top: 5px;
            right: 20px;
            font-size: 1.5rem;
            transition: all 0.4s ease;
        }

        .close_modal_rule:hover {
            cursor: pointer;
            opacity: 0.7;
        }

        .info_modal_rule {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .info_modal_rule select {
            width: 200px;
        }

        .info_modal_rule h2 {
            position: absolute;
            top: 20px;
            left: 40px;
        }

        .content_opciones_ruleta {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .content_opciones_ruleta img {
            width: 30px;
            transition: all 0.4s ease;
        }

        .content_opciones_ruleta img:hover {
            opacity: 0.7;
            cursor: pointer;
        }


        @media(max-width: 968px) {
            .content_info_admin {
                flex-direction: column;
            }

            .content_menu_lat {
                width: 100%;
                height: auto;
                border-radius: 0;
            }

            .content_main_ruleta {
                width: 100%;
                height: 100%;
                border-radius: 0;
            }

            #roulette {
                width: 250px;
                height: 250px;
            }

            #roulette .roulette-section .roulette-section-container p {
                margin-top: -25px;
            }

            #selector {
                top: 40px;
            }

            .content_modal_rule {
                border-radius: 0;
                width: 100%;
                height: 100vh;
                max-height: 100%;
            }

            .content_opciones_ruleta,
            .olvidar_usuario {
                top: 10px;
            }

        }
    </style>
</head>

<body>
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
    </div>
    <section class="content_main_admin_ruleta">
        <div id="content_info_admin" class="content_info_admin">
            <div class="content_menu_lat">
                <div class="content_opciones_ruleta">
                    <button class="olvidar_usuario" id="olvidar_usuario_ruleta" title="Salir">Salir</button>
                    <img id="btn_opciones" title="Opciones" src="/resource/engranaje.png" alt="Aladdin">
                </div>
                <div class="content_info_menu_lat">
                    <h2>Detalle su Ruleta.</h2>
                    <div class="content_input_label menu_confi">
                        <p>INGRESA EL TITULO PRINCIPAL DE TU RULETA</p>
                        <input id="nombre_ruleta" type="text" class="form-control" placeholder="Título de tu ruleta">
                    </div>
                    <div class="content_input_label menu_confi">
                        <p>Define la cantidad de campos de tu ruleta.</p>
                        <span
                            style="color: rgb(0, 255, 34);font-size: 8px;display: flex;justify-content: start;align-items: start;width: 100%;">CON
                            UN MAXIMO DE 26 CAMPOS.</span>
                        <select class="form-control" name="slots" id="slots_ruleta">
                            <option value="">Seleccionar</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                        </select>
                    </div>
                    <div id="content_inputs" class="content_input_label content_inputs"></div>
                    <div class="content_input_label menu_confi">
                        <p>Dirección de la ruleta.</p>
                        <select name="direccion_rule" id="direccion_rule" class="form-control">
                            <option value="">Seleccionar</option>
                            <option value="1">Derecha</option>
                            <option value="-1">Izquierda</option>
                        </select>
                    </div>
                    <div class="content_input_label menu_confi">
                        <p>Giros mínimos.</p>
                        <input type="number" class="form-control" id="giros_minimo" placeholder="# de Giros">
                    </div>
                    <div class="content_input_label menu_confi">
                        <p>Giros máximos.</p>
                        <input type="number" class="form-control" id="giros_maximo" placeholder="# de Giros">
                    </div>
                    <div class="content_input_label">
                        <button title="Limpiar" class="btn_clean_board" id="btn_clean_board">Limpiar</button>
                        <button id="btn_submit_ruleta" title="Crear Ruleta" class="btn_crear_ruleta">Crear
                            Ruleta</button>
                    </div>
                </div>
            </div>
            <div class="content_main_ruleta">
                <div class="content_infor_main_ruleta">
                    <h2>
                        <p id="nombre_de_la_ruleta"></p>
                    </h2>
                    <section id="roulette-container" class="roulette-container config_view_ruleta">
                        <div class="button-container">
                            <button type="button" id="spin">¡Girar!</button>
                        </div>
                        <div id="selector"></div>
                        <div id="roulette">
                            <div id="roulette-center"></div>
                        </div>
                        <div class="content_confetti"></div>
                    </section>
                    <button id="btn_enviar_ruleta" class="btn_enviar_ruleta">Enviar Ruleta</button>
                    <div class="content_info_user">
                        <span id="usuario"></span>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <div id="modal_opciones_" class="modal_opciones_rule">
        <div class="content_modal_rule">
            <div id="close_modal_rule" class="close_modal_rule">&times;</div>
            <div class="info_modal_rule">
                <h2>Eliminar ruleta</h2>
                <br />
                <select class="form-control" name="ruletas" id="ruletas_eliminar">
                    <option value="">Seleccionar...</option>
                </select>
                <br />
                <div>
                    <button id="btn_eliminar" class="btn btn-danger">Eliminar</button>
                    <button style="display: none;" id="btn_cargar_rule_eliminar" class="btn btn-primary">Cargar
                        Ruletas</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="/dinamicas/promocion-ruleta-dinamica/admin_view_ruleta/admin_view_ruleta.js"></script>
    <script>
        window.addEventListener("load", () => {
            document.getElementById("loader").style.display = "none";
        });

        window.addEventListener("DOMContentLoaded", () => {
            const view_admin = document.getElementById("content_info_admin");
            const slots_ruleta = document.getElementById("slots_ruleta");
            const content_inputs = document.getElementById("content_inputs");
            const btn_submit_ruleta = document.getElementById("btn_submit_ruleta");
            const nombre_ruleta = document.getElementById("nombre_ruleta");
            const btn_enviar_ruleta = document.getElementById("btn_enviar_ruleta");
            const direccion_rule = document.getElementById("direccion_rule");
            const giros_minimo = document.getElementById("giros_minimo");
            const giros_maximo = document.getElementById("giros_maximo");
            const roulette = document.getElementById("roulette");
            const loader = document.getElementById("loader");
            const btn_clean_board = document.getElementById("btn_clean_board");
            const btn_opciones = document.getElementById("btn_opciones");
            const close_modal_rule = document.getElementById("close_modal_rule");
            const ruletas_eliminar = document.getElementById("ruletas_eliminar");
            const btn_eliminar = document.getElementById("btn_eliminar");
            const btn_cargar_rule_eliminar = document.getElementById("btn_cargar_rule_eliminar");

            const url_ruleta =
                "https://script.google.com/macros/s/AKfycbxDn2u1somk0VSw2_A4y92UCmoI1ypu5hvHK14QEq3ge_l98t6biNy2EstWusj1K4Tq/exec";


            giros_minimo.addEventListener("input", () => {
                let min = giros_minimo.value;
                let max = giros_maximo.value;
                if (Number(min) > Number(max)) {
                    giros_minimo.classList.add("campo_incorrecto");
                } else {
                    giros_minimo.classList.remove("campo_incorrecto");
                }
            });

            giros_maximo.addEventListener("input", () => {
                let min = giros_minimo.value;
                let max = giros_maximo.value;
                if (Number(min) > Number(max)) {
                    giros_minimo.classList.add("campo_incorrecto");
                } else {
                    giros_minimo.classList.remove("campo_incorrecto");
                }
            });

            btn_opciones.addEventListener("click", () => {
                document.getElementById("modal_opciones_").style.display = "flex";
                getAllRuleta();
            });

            close_modal_rule.addEventListener("click", () => {
                document.getElementById("modal_opciones_").style.display = "none";
            });

            btn_eliminar.addEventListener("click", () => {
                let nombre_rule = ruletas_eliminar.value;
                if (nombre_rule == "") {
                    Swal.fire({
                        icon: "warning",
                        title: "Selecciona una ruleta existente.",
                    });
                    return;
                }

                let data = {
                    tipo: "delete",
                    hoja: "Ruletas",
                    match: {
                        nombre_ruleta: ruletas_eliminar.value
                    }
                }

                loader.style.display = "flex";
                fetch(url_ruleta, {
                    method: "POST",
                    mode: "no-cors",
                    body: JSON.stringify(data)
                }).then((res) => res.text())
                    .then(() => {
                        loader.style.display = "none";
                        ruletas_eliminar.value = "";
                        getAllRuleta();
                        Swal.fire({
                            icon: "success",
                            title: "Ruleta eliminada"
                        });
                    }).catch((error) => {
                        loader.style.display = "none";
                        console.log(error);
                        Swal.fire({
                            icon: "error",
                            title: "Ha ocurrido un error.",
                            html: "No se pudo eliminar la ruleta, comunícate con el área de comunicaciones"
                        })
                    })
            });


            let conteo_campos = "";

            function setCookie(name, value, opts = {}) {
                const {
                    hours = 1,
                    path = "/",
                    sameSite = "Lax",
                    secure = location.protocol === "https:",
                } = opts;

                const expires = new Date(Date.now() + hours * 60 * 60 * 1000).toUTCString();
                const encoded = encodeURIComponent(JSON.stringify(value));
                let cookie = `${name}=${encoded}; Expires=${expires}; Path=${path}; SameSite=${sameSite}`;
                if (secure) cookie += `; Secure`;
                document.cookie = cookie;
            }

            function getCookie(name) {
                const parts = document.cookie ? document.cookie.split("; ") : [];
                for (const part of parts) {
                    const [k, ...rest] = part.split("=");
                    if (k === name) {
                        const val = rest.join("=");
                        try {
                            return JSON.parse(decodeURIComponent(val));
                        } catch {
                            return decodeURIComponent(val);
                        }
                    }
                }
                return null;
            }

            cookieEmpty();

            function cookieEmpty() {
                const u = getCookie("user_admin_ruleta");
                if (!u) {
                    view_admin.style.display = "none";
                    validateindentity();
                } else {
                    view_admin.style.display = "flex";
                    const user = getCookie("user_admin_ruleta");
                    document.getElementById("usuario").textContent =
                        "Usuario logeado: " + user.User;
                }
            }

            btn_clean_board.addEventListener("click", () => {
                Swal.fire({
                    title: "Estas seguro?",
                    text: "Se reiniciara todo en pantalla",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Si Quiero!",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: "Reinicio exitoso",
                            icon: "success",
                            allowOutsideClick: false,
                        }).then((res) => {
                            if (res.isConfirmed) {
                                window.location.reload();
                            }
                        });
                    }
                });
            });

            slots_ruleta.addEventListener("change", () => {
                content_inputs.innerHTML = "";
                document.getElementById("roulette-container").style.display = "none";
                conteo_campos = slots_ruleta.value;
                for (let i = 0; i < slots_ruleta.value; i++) {
                    const torta = document.createElement("input");
                    torta.id = `campo_ruleta_${i + 1}`;
                    torta.classList.add("form-control");
                    torta.placeholder = `Campo ${i + 1}`;
                    content_inputs.appendChild(torta);
                }
            });

            function obtenerCamposRuleta() {
                const inputs = content_inputs.querySelectorAll(
                    "input[id^='campo_ruleta_']"
                );
                const valores = [];

                inputs.forEach((inp) => {
                    const texto = inp.value.trim();
                    if (texto !== "") {
                        valores.push(texto);
                    }
                });

                return valores;
            }

            function validateindentity() {
                const url =
                    "https://script.google.com/macros/s/AKfycbyu8Ank3dFeLnJOiTZsDUuRdvD7PP-p-i2k9UeqRyqPiGR0hGDDLAJXlzt989HqYBQ/exec";

                Swal.fire({
                    title: `<img class="content_img_head" src="/resource/logo-aladdin-rojo-grande.png" />`,
                    html: `<div class="test_input">
                                <input id="swal-user" name="user" class="swal2-input input_validate_xp" placeholder="Usuario" autocomplete="current-password">
                                <input id="swal-pass" name="password" type="password" class="swal2-input input_validate_xp" placeholder="Contraseña" autocomplete="current-password">
                            </div>`,
                    inputAttributes: {
                        autocapitalize: "off",
                    },
                    showCancelButton: true,
                    confirmButtonText: "Iniciar",
                    showLoaderOnConfirm: true,
                    allowOutsideClick: false,
                    preConfirm: async () => {
                        const usuario = document.getElementById("swal-user").value.trim();
                        const cedula = document.getElementById("swal-pass").value.trim();

                        if (!usuario || !cedula) {
                            Swal.showValidationMessage("Completa la información");
                            return false;
                        }

                        try {
                            const githubUrl = `${url}?user=${encodeURIComponent(
                                usuario
                            )}&contra=${encodeURIComponent(cedula)}`;
                            const response = await fetch(githubUrl);

                            if (!response.ok) {
                                Swal.showValidationMessage(
                                    `Error en el servidor: ${response.status}`
                                );
                                return false;
                            }

                            const data = await response.json();

                            if (!Array.isArray(data) || data.length === 0) {
                                Swal.showValidationMessage(
                                    "Usuario o contraseña incorrectos, verifica la información."
                                );
                                return false;
                            }

                            return data;
                        } catch (error) {
                            console.error(error);
                            Swal.showValidationMessage(`Error de conexión: ${error}`);
                            return false;
                        }
                    },
                    customClass: {
                        popup: "mi-popup-xp",
                        title: "mi-titulo-xp",
                        confirmButton: "btn-Send-xp mi-boton",
                    },
                }).then((result) => {
                    if (result.isConfirmed) {
                        const data = result.value;

                        if (Array.isArray(data) && data.length > 0) {
                            setCookie("user_admin_ruleta", data[0]);
                            window.location.reload();
                        } else {
                            Swal.fire({
                                icon: "info",
                                title: "Usuario no encontrado",
                                html: "El usuario digitado no se encuentra, por favor comunícate con el área de comunicaciones.",
                                allowOutsideClick: false,
                                customClass: {
                                    popup: "mi-popup",
                                    title: "mi-titulo",
                                    confirmButton: "btn-Send mi-boton",
                                },
                            }).then((res) => {
                                if (res.isConfirmed) {
                                    validateindentity();
                                }
                            });
                        }
                    } else if (result.isDismissed) {
                        validateindentity(); // obligar login
                    }
                });
            }

            btn_submit_ruleta.addEventListener("click", () => {
                const labels = obtenerCamposRuleta();

                if (labels.length === 0) {
                    Swal.fire({
                        icon: "warning",
                        title: "Sin campos",
                        html: "Debes escribir al menos un campo para la ruleta.",
                    });
                    return;
                }

                if (
                    nombre_ruleta.value == "" ||
                    direccion_rule.value == "" ||
                    giros_minimo.value == "" ||
                    giros_maximo.value == ""
                ) {
                    Swal.fire({
                        icon: "warning",
                        title: "Campos en Blanco",
                        html: "Debes digitar la información para la ruleta.",
                    });
                    return;
                }

                if (giros_minimo.value > giros_maximo.value) {
                    Swal.fire({
                        icon: "warning",
                        title: "El valor mínimo no puede superar el valor máximo.",
                    });
                    return;
                }

                document.getElementById("roulette-container").style.display = "flex";
                construirRuleta(labels);

                loadingRuleta(
                    document.getElementById("nombre_ruleta").value,
                    labels.length,
                    direccion_rule.value,
                    giros_minimo.value,
                    giros_maximo.value
                );
            });

            btn_enviar_ruleta.addEventListener("click", () => {
                handleSubmitRuleta();
            });

            function handleSubmitRuleta() {
                if (document.getElementById("roulette-container").style.display != "flex") {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Debes tener una ruleta valida para poder enviar.",
                    });
                    return;
                }

                Swal.fire({
                    title: "Estas seguro?",
                    text: "Se enviara los datos para la ruleta",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Si Quiero!",
                    allowOutsideClick: false,
                }).then((result) => {
                    if (result.isConfirmed) {
                        const labels = obtenerCamposRuleta();
                        let canti_campos = labels.length;

                        let nombreRuleta = nombre_ruleta.value;
                        let slotsRuleta = slots_ruleta.value;
                        let direccionRuleta = direccion_rule.value;
                        let girosMinimos = giros_minimo.value;
                        let girosMaximos = giros_maximo.value;

                        const fechaCompleta = new Date().toLocaleString("es-CO", {
                            timeZone: "America/Bogota",
                            year: "numeric",
                            month: "2-digit",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit",
                            second: "2-digit",
                            hour12: false,
                        });

                        const [fecha, hora] = fechaCompleta.split(", ");

                        if (labels.length === 0) {
                            Swal.fire({
                                icon: "warning",
                                title: "Sin campos",
                                html: "Digita al menos un campo para la ruleta.",
                            });
                            return;
                        }

                        if (
                            nombreRuleta == "" ||
                            direccionRuleta == "" ||
                            girosMinimos == "" ||
                            girosMaximos == ""
                        ) {
                            Swal.fire({
                                icon: "warning",
                                title: "Antes de enviar",
                                text: "Completa la información para poder crear la ruleta",
                            });
                            return;
                        }

                        const user = getCookie("user_admin_ruleta");

                        const data = {
                            tipo: "ruletas",
                            hora,
                            fecha,
                            nombre_ruleta: nombreRuleta.toUpperCase(),
                            cant_campos: labels.length,
                            direccion: direccion_rule.value,
                            giros_minimo: girosMinimos,
                            girosMaximos: girosMaximos,
                            creador: user.User
                        };

                        // Llenar campo_1, campo_2, campo_3, ... dinámicamente
                        labels.forEach((texto, index) => {
                            const idx = index + 1;
                            data[`campo_${idx}`] = "." + texto.toUpperCase();
                        });

                        // aqui el fetch
                        loader.style.display = "flex";
                        fetch(`${url_ruleta}?hoja=ruletas`, {
                            method: "POST",
                            mode: "no-cors",
                            body: JSON.stringify(data),
                        })
                            .then((res) => res.text())
                            .then(() => {
                                loader.style.display = "none";
                                Swal.fire({
                                    title: "Exito!",
                                    text: "Tu Ruleta ha sido enviada.",
                                    icon: "success",
                                    allowOutsideClick: false,
                                });
                            })
                            .catch((error) => {
                                Swal.fire({
                                    title: "Error!",
                                    text: "Ha ocurrido un error, comunícate con el área de promociones.",
                                    icon: "error",
                                    allowOutsideClick: false,
                                });
                            });
                    }
                });
            }

            function getAllRuleta() {
                ruletas_eliminar.innerHTML = `<option value="">Cargando...</option>`;
                btn_eliminar.classList.add("item_disable");
                ruletas_eliminar.classList.add("item_disable");
                btn_cargar_rule_eliminar.classList.add("item_disable");

                fetch(url_ruleta)
                    .then((res) => res.json())
                    .then((data) => {
                        if (data.length === 0) {
                            ruletas_eliminar.style.display = "flex";
                            ruletas_eliminar.innerHTML = `<option value="">No hay ruletas</option>`;
                            btn_eliminar.classList.remove("item_disable");
                            ruletas_eliminar.classList.remove("item_disable");
                            btn_cargar_rule_eliminar.classList.remove("item_disable");
                            return;
                        }
                        allRuletas = Array.isArray(data) ? data : [];
                        const rondas = [...new Set(allRuletas.map((r) => r.nombre_ruleta))];
                        ruletas_eliminar.style.display = "flex";
                        ruletas_eliminar.innerHTML = `<option value="">Seleccione la Ruleta</option>`;
                        btn_eliminar.classList.remove("item_disable");
                        ruletas_eliminar.classList.remove("item_disable");
                        btn_cargar_rule_eliminar.classList.remove("item_disable");
                        rondas.forEach((lista) => {
                            if (!lista) return;
                            const option = document.createElement("option");
                            option.value = lista;
                            option.textContent = lista;
                            ruletas_eliminar.appendChild(option);
                        });
                    })
                    .catch((err) => console.error(err));
            }
        });

        document
            .getElementById("olvidar_usuario_ruleta")
            .addEventListener("click", () => {
                olvidarUsuarioRuleta();
            });

        function olvidarUsuarioRuleta() {
            Swal.fire({
                title: "Seguro de salir?",
                text: "Se olvidara el usuario y la contraseña",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Si Quiero!",
                allowOutsideClick: false,
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Exito!",
                        text: "Tu usuario has sido olvidado.",
                        icon: "success",
                        allowOutsideClick: false,
                    }).then((res) => {
                        if (res.isConfirmed) {
                            document.cookie = "user_admin_ruleta=; max-age=0; path=/;";
                            location.reload();
                        }
                    });
                }
            });
        }

        function construirRuleta(labels) {
            document.getElementById("nombre_de_la_ruleta").textContent =
                "Su Ruleta es: " + document.getElementById("nombre_ruleta").value;
            const roulette = document.getElementById("roulette");
            roulette.innerHTML = "";

            const cantidad = labels.length;
            if (cantidad === 0) return;

            const angle = 360 / cantidad;
            const skew = 90 - angle;

            labels.forEach((texto, index) => {
                const section = document.createElement("div");
                section.className = "roulette-section";

                section.style.transform = `rotate(${index * angle}deg) skewY(-${skew}deg)`;

                const container = document.createElement("div");
                container.className = "roulette-section-container";

                container.style.transform = `skewY(${skew}deg) rotate(${angle / 2}deg)`;

                const p = document.createElement("p");
                p.textContent = texto;

                if (cantidad <= 8) {
                    p.style.fontSize = "14px";
                } else if (cantidad <= 16) {
                    p.style.fontSize = "12px";
                } else {
                    p.style.fontSize = "10px";
                }

                container.appendChild(p);
                section.appendChild(container);
                roulette.appendChild(section);
            });

            const center = document.createElement("div");
            center.id = "roulette-center";
            roulette.appendChild(center);
        }

        function loadingRuleta(
            nombre_ruleta,
            canti_campos,
            direccion_rule,
            giros_minimo,
            giros_maximo
        ) {
            const roulette = document.querySelector("#roulette");
            const spinButton = document.querySelector("#spin");

            const sections = Array.from(
                document.querySelectorAll("#roulette .roulette-section-container p")
            );

            let currentRotation = 0;
            let spinDirection = direccion_rule;
            const maxSpins = giros_maximo;
            const minSpins = giros_minimo;

            function createConfetti() {
                const colors = [
                    "#f94144",
                    "#f3722c",
                    "#f9c74f",
                    "#90be6d",
                    "#577590",
                    "#43aa8b",
                    "#f72585",
                ];
                confetti({
                    particleCount: 200,
                    spread: 70,
                    origin: { y: 0.6 },
                });
                for (let i = 0; i < 100; i++) {
                    const conf = document.createElement("div");
                    conf.className = "confetti";
                    conf.style.left = Math.random() * 400 + "px";
                    conf.style.backgroundColor =
                        colors[Math.floor(Math.random() * colors.length)];
                    conf.style.animationDuration = Math.random() * 2 + 1.5 + "s";
                    document.querySelector(".content_confetti").appendChild(conf);
                    setTimeout(() => conf.remove(), 3000);
                }
            }

            spinButton.onclick = null;

            spinButton.onclick = () => {
                if (sections.length === 0) return;

                spinButton.style.display = "none";

                const spins =
                    Math.floor(Math.random() * (maxSpins - minSpins + 1)) + minSpins;
                const degreesRandom = Math.floor(Math.random() * 360);

                const giroBase = spins * 360 + degreesRandom;
                const extraRotation = spinDirection * giroBase;

                currentRotation += extraRotation;
                roulette.style.transition = `transform ${spins}s ease-out`;
                roulette.style.transform = `rotate(${currentRotation}deg)`;

                const handler = () => {
                    roulette.removeEventListener("transitionend", handler);
                    spinButton.style.display = "flex";

                    const normalizedDeg =
                        (360 - (((currentRotation % 360) + 360) % 360) + 360) % 360;

                    const anguloPorSeccion = 360 / sections.length;
                    const index =
                        Math.floor(normalizedDeg / anguloPorSeccion) % sections.length;
                    const resultText = sections[index].textContent;

                    if (resultText.toUpperCase().includes("GANA")) {
                        createConfetti();
                        alert(` ¡Felicidades! ${resultText} `);
                    }

                    spinDirection = direccion_rule;
                };

                roulette.addEventListener("transitionend", handler);
            };

        }

    </script>
     <script src="/dinamicas/extension.js"></script>
</body>

</html>